services:
  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
    container_name: kfcweb-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot
    depends_on:
      - users-api
      - settings-api
    restart: unless-stopped
    networks:
      - kfcweb-network

  users-api:
    build:
      context: ./MyUsers.Api
      dockerfile: Dockerfile
    container_name: kfcweb-users-api
    expose:
      - "5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=${DB_CONNECTION_STRING_USERS}
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - SettingsApiUrl=http://settings-api:5001
      - FrontendUrl=${FrontendUrl}
      - EmailSettings__Enabled=${EmailSettings__Enabled}
      - EmailSettings__SmtpHost=${EmailSettings__SmtpHost}
      - EmailSettings__SmtpPort=${EmailSettings__SmtpPort}
      - EmailSettings__SmtpUsername=${EmailSettings__SmtpUsername}
      - EmailSettings__SmtpPassword=${EmailSettings__SmtpPassword}
      - EmailSettings__FromEmail=${EmailSettings__FromEmail}
      - EmailSettings__FromName=${EmailSettings__FromName}
      - EmailSettings__UseSsl=${EmailSettings__UseSsl}
      - CorsSettings__AllowedOrigins__0=${CorsSettings__AllowedOrigins__0}
      - CorsSettings__AllowedOrigins__1=${CorsSettings__AllowedOrigins__1}
    restart: unless-stopped
    networks:
      - kfcweb-network

  settings-api:
    build:
      context: ./MySettings.Api
      dockerfile: Dockerfile
    container_name: kfcweb-settings-api
    expose:
      - "5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
      - ConnectionStrings__DefaultConnection=${DB_CONNECTION_STRING_SETTINGS}
      - JwtSettings__SecretKey=${JWT_SECRET_KEY}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - UsersApiUrl=http://users-api:5000
      - CorsSettings__AllowedOrigins__0=${CorsSettings__AllowedOrigins__0}
      - CorsSettings__AllowedOrigins__1=${CorsSettings__AllowedOrigins__1}
    restart: unless-stopped
    networks:
      - kfcweb-network

networks:
  kfcweb-network:
    driver: bridge
